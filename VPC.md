参照 : https://en-junior.com/vpc/

ネットワークの範囲 

: IPアドレスの利用可能な範囲

  例 10.0.1.0/16 ⇒ 10.0.1.0(IPアドレス) + サブネットマスク(/16)がIPアドレスの範囲を決める

IPアドレスは3桁(0~255)×4つの組み合わせで、各桁が8つのバイナリ値(0 or 1)の集合を表す

サブネットマスク(/32がMAX)

CIDR(サイダー)(Classless Inter-Domain Routing) : サブネットマスクの値を設定し、同じネットワークとして扱う。IPアドレスのIPアドレスの個数を調整できるIPアドレスの設定方法。一般的にVPCを使う時は/16を使う。

すでにAWS側で利用されており、設定できないアドレス。

/24の例

| ホストアドレス | 用途 |
| --- | --- |
| .0 | ネットワークアドレス |
| .1 | VPCルータ |
| .2 | Amazonが提供するDNSサービス |
| .3 | AWSで予約されているアドレス |
| .255 | ブロードキャストアドレス |

例 10.0.1.0/16 ⇒ 左から16桁目までが同じネットワーク範囲と指定。「10.0」までロック。ロックされていないところがIPアドレスとして利用できる。また、「10.0」の箇所を「ネットワーク部」、「1.0」の箇所を「ホスト部」と呼ぶ。

- ネットワーク部 : サブネットマスクによって固定される範囲。
- ホスト部 : 利用可能な範囲

サブネットを使うことで、グループ化を行うことができ、端末を特定すxることが容易になる。また、役割分担でまとめることができる。

※**サブネット** : CIDRで分割したVPCのネットワークセグメント(かたまり、グループ)。既存でルータが存在する。

   **パブリックサブネット** : インターネットゲートウェイにルーティングされるサブネット。

   **プライベートサブネット** : インターネットゲートウェイへのルートがないサブネット。セキュリティを高めたいリソース

VPC(Virtul Private Cloud) : AWSクラウドのネットワークからユーザ専用の領域を切り出すことができる仮想ネットワークサービス。

- リージョン内に5つまでVPCを設定可能。増やすことはできる。
- **任意のIPIPアドレス範囲(CIDR)を選択して仮想ネットワークを構築  最大サイズ : /16 最小サイズ : /28**
- **VPCはプライベートIPアドレスによってネットワークレンジを設定**
- S3はリージョンに作られて、VPCには作られない

VPCがネットワークの範囲を設定し、さらにサブネットに範囲を分割して利用する

**1つのVPCと1つのサブネットが最小単位**。単一サブネットがAZの範囲に設定される。

サブネットを追加することで複数AZ範囲にVPCを広げることができる

**VPCはリージョンを超えることはできない**

VPCあたりのサブネット作成上限数は200個

デフォルトでは各リージョンごとにVPCが作成されている

AWSアカウントを作成すると自動的に各リージョンに1つずつデフォルトVPCとデフォルトサブネットが作成される

**VPCウィザード** : ネット構成を一度に作成できる

カスタムVPCの作成 ⇒ VPCウィザードを使わない場合は、VPC、サブネットを1つずつ作成していく。

**VPCエンドポイント** : 同じVPC内でのみ有効であり、異なるVPC間での通信には別の手段が必要です（例: VPC Peering）。しかし、同じVPC内の異なるサブネットにいるリソース間での通信において、VPCエンドポイントは便利なツールとなります。

ルートテーブル : どのサブネットがどのインターネットゲートウェイを使うのか

ゲートウェイの設定

- **インターネットゲートウェイ**

インターネットの出入り口となるゲートウェイ。デフォルトゲートウェイとして利用されることが多い。**インターネットゲートウェイをVPCに1つ設置する。ルートテーブルが必要。**

- **NATゲートウェイ　アドレス変換を行う**

プライベートサブネットのリソースからインターネットのトラフィックを可能にするためのゲートウェイ。プライベートアドレスをパブリックアドレスに変換して、インターネットゲートウェイに連携させる。使われていないElastic IPアドレスは有料。**NATゲートウェイを作成するとElastic IPアドレスが自動で作成**される。

**NATゲートウェイにElastic IPアドレスが付与されることで、プライベートサブネットが一意のIPアドレスを持つことができ、外部にアクセスできるようになる。**

- **Egress-Only Internet Gateway**

IPv6向けのインターネットゲートウェイ。IPv6経由でのVPCからインターネットへの送信を可能にし、インターネットからのインスタンスへの接続は防ぐ

- **カスタマーゲートウェイ**

オンプレミス環境と接続する際に利用するゲートウェイ。カスタマーゲートウェイデバイスまたはソフトウェアアプリケーションに関する情報をAWSに提供する

- **仮想プライベートゲートウェイ**

VPNトンネルのAmazon側にあるルーター。VPN接続時に利用する。

VPCにおけるDNSの利用

enableDnsHostnames : パブリックIPアドレスを持つインスタンスが、対応するパブリックDNSホスト名を取得するかどうか示す。この属性がtrueでenableDnsSupport属性もtrueの場合、VPCのインスタンスはDNSホスト名を取得する

enableDnsSupport : DNS解決がサポートされているかどうかを示す。この属性がfalseの場合、パブリックDNSホスト名をIPアドレスに解決するRoute 53 Resolverサーバが機能しない。この属性がtrueの場合、Amazonが提供するDNSサーバ(IPアドレス 169.254.169.253)へのクエリ、またはリザーブドIPアドレス(VPC IPv4ネットワークの範囲に2をプラスしたアドレス)へのクエリは成功する

⇒ Route53でプライベートホストゾーンにカスタムDNSドメイン名を利用したい場合に設定が必要。

**DHCPサーバ** : ローカル端末に対してプライベートIPアドレスを付与する。

グローバルIPアドレスとプライベートIPアドレスを対応付けするのがNATという機器またはソフトウェア。

ネットワークに接続する際に、プライベートIPアドレスは利用できない。(なぜなら、重複してしままうから。)

インターネットに接続する際は、NATがグローバルIPアドレスに変換してくれる。

**IPマスカレード** : 複数のプライベートIPアドレスをグローバルIPアドレスに変換する。NATは1対1での変換しかできない。

DHCPサーバ、NAT、IPマスカレードが一つになっているのが家庭にあるようなルーター。

プライベートサブネットにEC2を設置すると、インターネットにアクセスできない。そこで、パブリックサブネットに踏み台サーバを設置する。

パブリックIP

- 動的なパブリックIPv4アドレス
- インスタンスが停止した場合はIPアドレスは変更される
- VPCでパブリックIPアドレスの割当が有効化されていれば自動的にVPC内リソースに割り当てられる
- 無料

Elastic IP : 静的に利用できる追加のIPアドレス。インスタンスがインターネットにアクセスするためには、パブリックIPかElastic IPを利用。

- 静的なパブリックIPv4アドレス
- インスタンスが停止してもIPアドレスは変更しない
- VPCコンソールにおいてElastic IPを作成してから、必要なサービスにアタッチする。
- 利用時は無料。解放せずに利用しないと有料。
