参照 : https://en-junior.com/vpc/

ネットワークの範囲 

: IPアドレスの利用可能な範囲

  例 10.0.1.0/16 ⇒ 10.0.1.0(IPアドレス) + サブネットマスク(/16)がIPアドレスの範囲を決める

IPアドレスは3桁(0~255)×4つの組み合わせで、各桁が8つのバイナリ値(0 or 1)の集合を表す

サブネットマスク(/32がMAX)

CIDR(サイダー)(Classless Inter-Domain Routing) : サブネットマスクの値を設定し、同じネットワークとして扱う。IPアドレスのIPアドレスの個数を調整できるIPアドレスの設定方法。一般的にVPCを使う時は/16を使う。

すでにAWS側で利用されており、設定できないアドレス。

/24の例

| ホストアドレス | 用途 |
| --- | --- |
| .0 | ネットワークアドレス |
| .1 | VPCルータ |
| .2 | Amazonが提供するDNSサービス |
| .3 | AWSで予約されているアドレス |
| .255 | ブロードキャストアドレス |

例 10.0.1.0/16 ⇒ 左から16桁目までが同じネットワーク範囲と指定。「10.0」までロック。ロックされていないところがIPアドレスとして利用できる。また、「10.0」の箇所を「ネットワーク部」、「1.0」の箇所を「ホスト部」と呼ぶ。

- ネットワーク部 : サブネットマスクによって固定される範囲。
- ホスト部 : 利用可能な範囲

サブネットを使うことで、グループ化を行うことができ、端末を特定すxることが容易になる。また、役割分担でまとめることができる。

※**サブネット** : CIDRで分割したVPCのネットワークセグメント(かたまり、グループ)。既存でルータが存在する。1つのAZに属する。

   **パブリックサブネット** : インターネットゲートウェイにルーティングされるサブネット。

   **プライベートサブネット** : インターネットゲートウェイへのルートがないサブネット。セキュリティを高めたいリソース

VPC(Virtul Private Cloud) : AWSクラウドのネットワークからユーザ専用の領域を切り出すことができる仮想ネットワークサービス。

- リージョン内に5つまでVPCを設定可能。増やすことはできる。
- **任意のIPIPアドレス範囲(CIDR)を選択して仮想ネットワークを構築  最大サイズ : /16 最小サイズ : /28**
- **VPCはプライベートIPアドレスによってネットワークレンジを設定**
- S3はリージョンに作られて、VPCには作られない

VPCがネットワークの範囲を設定し、さらにサブネットに範囲を分割して利用する

**1つのVPCと1つのサブネットが最小単位**。単一サブネットがAZの範囲に設定される。

サブネットを追加することで複数AZ範囲にVPCを広げることができる

**VPCはリージョンを超えることはできない**

**VPCあたりのサブネット作成上限数は200個**

デフォルトでは各リージョンごとにVPCが作成されている

AWSアカウントを作成すると自動的に各リージョンに1つずつデフォルトVPCとデフォルトサブネットが作成される

**VPCウィザード** : ネット構成を一度に作成できる

カスタムVPCの作成 ⇒ VPCウィザードを使わない場合は、VPC、サブネットを1つずつ作成していく。

**VPCエンドポイント** : セキュリティ上の制約でインターネットとの通信が制限されているプライベートサブネット内のAWSリソースから、インターネットゲートウェイを経由せずにVPC外のAWSサービスへアクセス可能にする機能。**アクセスする側に設定する。**

VPCエンドポイントを使用しないで、VPC外のAWSリソースにアクセスしようすると、NATゲートウェイを使ってアクセスすることになる。

**VPCエンドポリシー** : VPCエンドポイントからの接続先を制限する際に用いる。VPCエンドポイントのゲートウェイ型とAWS PrivateLink（インターフェイス型）の両方で利用できる。VPCエンドポイントポリシーを設定するには、許可/拒否する接続先のAmazonリソース名（ARN）を指定します。

- **ゲートウェイ型** : サポートされるAWSサービスを宛先とするトラフィックのルートテーブルの宛先として指定できるデートウェイ。**DynamoDBとS3のみに適用可能**
- **インターフェース型** : サポートされるサービスを宛先とするトラフィックのエントリーポイントとして機能するサブネットのIPアドレス範囲のプライベートIPアドレスを持つElastic Network Interface。**プライベートIPアドレスを使用してサービスにプライベートにアクセスする。**AWS PrivateLinkは、VPCとサービス間の全てのネットワークトラフィックをAmazonネットワークに制限。RDS ,EC2など多くのAWSサービスに適用可能。**2022年より、S3にも対応。**DynamoDBには未対応。

![スクリーンショット 2024-01-19 18.22.23.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/3fa88b57-9dc5-4cee-b7c0-84521fe7acdf/d01cfbfd-3020-4db7-8efa-ff0ed56b6daf/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2024-01-19_18.22.23.png)

ルートテーブル : どのサブネットがどのインターネットゲートウェイを使うのか。VPC内での通信において、どのネットワークへデータを転送するかを定義する機能

ルートテーブルの例

![スクリーンショット 2024-01-19 17.53.03.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/3fa88b57-9dc5-4cee-b7c0-84521fe7acdf/eeea49ea-4468-45bd-8cb8-ab628c7c9072/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2024-01-19_17.53.03.png)

10.0.0.0/16 ⇒ 10.0.0.0 ~ 10.0.255.255のIPアドレスからの送信は「local」へルーティング(送信先ごとに指定したターゲットへデータを転送すること)される。

10.0.0.0/16に当てはまらない全てのIPアドレスからの送信は「igw」へルーティングされる。

CIDRブロックが「172.16.0.0/18」のVPCに「172.16.0.0/24」のサブネットを作成した場合、VPC内のサブネット数と1つのサブネット当たりに利用できるIPアドレスは、以下のようになります。

・サブネット数 ＝ 2^(サブネットのプレフィックス長 - VPCのプレフィックス長) = 2^(24-18) = 64

・1サブネット当たりのIPアドレス数 = 2^(32 - サブネットのプレフィックス長)-5 = 2^(32-24)-5 = 251

ルーティング : ルートテーブルに従って、送信先ごとに指定したターゲットへデータを転送すること

ゲートウェイの設定

- **インターネットゲートウェイ**

インターネットの出入り口となるゲートウェイ。デフォルトゲートウェイとして利用されることが多い。**インターネットゲートウェイをVPCに1つ設置する。ルートテーブルが必要。**

1つのVPCに一つしか作成できない。

- **NATゲートウェイ　プライベートIPアドレス→Elastic IPアドレス(NATゲートウェイのパブリックIPアドレス)へ変換を行う**

プライベートサブネットのリソースからインターネットのトラフィックを可能にするためのゲートウェイ。プライベートアドレスをパブリックアドレスに変換して、インターネットゲートウェイに連携させる。使われていないElastic IPアドレスは有料。**NATゲートウェイを作成するとElastic IPアドレスが自動で作成**される。

**NATゲートウェイにElastic IPアドレスが付与されることで、プライベートサブネットが一意のIPアドレスを持つことができ、外部にアクセスできるようになる。**

外部からのアクセスをNATゲートウェイに通すことは不可能。

適用方法  ⇒ **Elastic IPアドレスを割り当てたNATゲートウェイをパブリックサブネット内に作成し、プライベートサブネットのルートテーブルにターゲットがNATゲートウェイのルーティングを設定**

NATゲートウェイは、**パブリックサブネットに設置。プライベートサブネットのルートテーブルにNATゲートウェイへのルーティングを設定。**

![スクリーンショット 2024-01-21 14.15.51.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/3fa88b57-9dc5-4cee-b7c0-84521fe7acdf/02da26b7-1e87-4a1e-944d-da0dde35ef3a/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2024-01-21_14.15.51.png)

接続タイプ

- パブリック ⇒ NATゲートウェイがインターネットに接続する必要がある時設定。
- プライベート ⇒ 上記以外のとき

 ****

⚠️**NATインスタンス :** プライベートサブネットからインターネットへの通信を可能にするIPv4専用の機能です。NATゲートウェイはマネージドサービスなのに対し、NATインスタンスはEC2インスタンスから作成するため、ユーザーが障害対応などの運用管理を実施する必要がある

NATゲートウェイとの違い ⇒ **ポート転送**機能(インターネットから送信された特定のポート番号宛のデータを、プライベートサブネット内にあるインスタンスの別のポートへ転送すること)や、VPC外からプライベートサブネット内へ接続する際の**踏み台サーバーとして利用**できる

- **Egress-Only Internet Gateway**

IPv6向けのインターネットゲートウェイ。**IPv6経由でのVPCからインターネットへの送信を可能にし、インターネットからのインスタンスへの接続は防ぐ**

- **カスタマーゲートウェイ**

オンプレミス環境と接続する際に利用するゲートウェイ。カスタマーゲートウェイデバイスまたはソフトウェアアプリケーションに関する情報をAWSに提供する

- **仮想プライベートゲートウェイ**

VPNトンネルのAmazon側にあるルーター。VPN接続時に利用する。

VPCにおけるDNSの利用

enableDnsHostnames : パブリックIPアドレスを持つインスタンスが、対応するパブリックDNSホスト名を取得するかどうか示す。この属性がtrueでenableDnsSupport属性もtrueの場合、VPCのインスタンスはDNSホスト名を取得する

enableDnsSupport : DNS解決がサポートされているかどうかを示す。この属性がfalseの場合、パブリックDNSホスト名をIPアドレスに解決するRoute 53 Resolverサーバが機能しない。この属性がtrueの場合、Amazonが提供するDNSサーバ(IPアドレス 169.254.169.253)へのクエリ、またはリザーブドIPアドレス(VPC IPv4ネットワークの範囲に2をプラスしたアドレス)へのクエリは成功する

⇒ Route53でプライベートホストゾーンにカスタムDNSドメイン名を利用したい場合に設定が必要。

**DHCPサーバ** : ローカル端末に対してプライベートIPアドレスを付与する。

グローバルIPアドレスとプライベートIPアドレスを対応付けするのがNATという機器またはソフトウェア。

ネットワークに接続する際に、プライベートIPアドレスは利用できない。(なぜなら、重複してしままうから。)

インターネットに接続する際は、NATがグローバルIPアドレスに変換してくれる。

**IPマスカレード** : 複数のプライベートIPアドレスをグローバルIPアドレスに変換する。NATは1対1での変換しかできない。

DHCPサーバ、NAT、IPマスカレードが一つになっているのが家庭にあるようなルーター。

プライベートサブネットにEC2を設置すると、インターネットにアクセスできない。そこで、パブリックサブネットに踏み台サーバを設置する。

パブリックIP

- 動的なパブリックIPv4アドレス
- インスタンスが停止した場合はIPアドレスは変更される
- VPCでパブリックIPアドレスの割当が有効化されていれば自動的にVPC内リソースに割り当てられる
- 無料

Elastic IP : 静的に利用できる追加のIPアドレス。インスタンスがインターネットにアクセスするためには、パブリックIPかElastic IPを利用。

- 静的なパブリックIPv4アドレス
- インスタンスが停止してもIPアドレスは変更しない
- VPCコンソールにおいてElastic IPを作成してから、必要なサービスにアタッチする。
- 利用時は無料。解放せずに利用しないと有料。
- Elastic IPアドレス（後述）ではないパブリックIPアドレスは、AWSリソースが停止する時にIPアドレスが解放（AWSに返却）され、AWSリソースが起動する時に新規のIPアドレスが割り当てられます。

**VPCピアリング** : VPC同士を1対1で接続する機能。同一アカウントのVPC同士や他のAWSアカウントのVPC、異なるリージョンのVPCでも、同一のプライベートネットワーク内に存在しているかのように相互に通信できる。

![スクリーンショット 2024-01-19 18.25.03.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/3fa88b57-9dc5-4cee-b7c0-84521fe7acdf/e8874743-a139-4503-a1f3-fd65ea877ae5/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2024-01-19_18.25.03.png)

**AWS Transit Gateway** : **複数のVPCや複数のオンプレミスネットワークを相互に接続するハブ(中継)機能を持つサービス**です。VPCピアリングはVPC同士を1対1で接続するサービスなのに対し、Transit Gatewayは複数のVPCを1つのハブで相互に接続できるのでネットワーク経路を簡素化できます。Transit GatewayはVPC間の他に、AWS Direct ConnectやAWS VPNで接続されたオンプレミスネットワークとも接続できます。AWS Direct ConnectとAWS VPNはともに、オンプレミスなどAWS外のネットワークとAWS内のネットワークをセキュアに接続するサービス。

![スクリーンショット 2024-01-19 18.26.53.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/3fa88b57-9dc5-4cee-b7c0-84521fe7acdf/75dd1ae0-0f1f-4ab1-b4b5-68c29b7b1436/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2024-01-19_18.26.53.png)

ENI(Elastic Network Interface)

**VPCフローログ** : ネットワークトラフィックを取得し、CloudWatchでモニタリングできるようにする機能。

- ネットワークトラフィックを送信元/送信先とするトラフィックが対象

⇒ **VPCのフローログ、サブネットのフローログ、ENIのフローログ** 

- セキュリティーグループとネットワークACLのルールでaccept/rejectされたトラフィックログを取得する
- キャプチャウィンドウと呼ばれる時間枠(約10分間)で収集・プロセッシング・保存する
- **機能自体に追加料金はかからないが、蓄積されるログデータ自体には課金される。**

VPC内のENIに流れるネットワークトラフィック情報を出力する機能。一定期間(最大集約間隔)のフローログをためてから送ることができる。

![スクリーンショット 2024-01-19 19.22.20.png](https://prod-files-secure.s3.us-west-2.amazonaws.com/3fa88b57-9dc5-4cee-b7c0-84521fe7acdf/a06f0d5e-9ea7-4761-8a8a-b37f12134003/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88_2024-01-19_19.22.20.png)
